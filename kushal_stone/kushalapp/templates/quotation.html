{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Create Quotation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .item-group {
            margin-bottom: 15px;
        }
    </style>
</head>

<body>
    {% include 'Sales_Base.html' %}

    <div class="container">
        <h2 class="mb-4 text-center text-primary">Create Quotation</h2>

        {% if messages %}
        <div class="mb-3">
            {% for message in messages %}
            <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}success{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <form method="POST" class="bg-white p-4 rounded shadow-sm">
            {% csrf_token %}

            <!-- Step 1 -->
            <div class="step step-1 active">
                <h4 class="mb-3">Step 1: Customer Info</h4>

                <div class="mb-3">
                    <label for="mobile" class="form-label">Mobile Number:</label>
                    <div class="input-group">
                        <input type="text" id="mobile" name="mobile" class="form-control"
                            value="{{ lead.mobile_number|default:'' }}" required>
                        <button type="submit" name="fetch_lead" class="btn btn-outline-primary">Fetch Lead</button>
                    </div>
                </div>

                {% if lead %}
                <div class="mb-3">
                    <label class="form-label">Full Name:</label>
                    <input type="text" class="form-control" name="full_name" value="{{ lead.full_name }}">
                </div>

                <div class="mb-3">
                    <label class="form-label">Email:</label>
                    <input type="email" class="form-control" name="email" value="{{ lead.email }}">
                </div>

                <div class="mb-3">
                    <label class="form-label">Address:</label>
                    <textarea class="form-control" name="address" rows="3">{{ lead.address }}</textarea>
                </div>


                <button type="button" class="btn btn-primary" onclick="goToStep(2)">Next</button>
                {% endif %}
            </div>

            {% if lead %}
            <!-- Step 2 -->
            <div class="step step-2">
                <h4 class="mb-3 mt-4">Step 2: Quotation Details</h4>

                <div class="mb-3">
                    <label class="form-label">Select Products:</label>
                    {% for product in products %}
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input item-checkbox" data-type="product"
                            value="{{ product.id }}" name="products">
                        <label class="form-check-label">{{ product.name }}</label>
                    </div>
                    {% endfor %}
                    <div id="product-fields" class="mt-3"></div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Select Services:</label>
                    {% for service in services %}
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input item-checkbox" data-type="service"
                            value="{{ service.id }}" name="services">
                        <label class="form-check-label">{{ service.name }}</label>
                    </div>
                    {% endfor %}
                    <div id="service-fields" class="mt-3"></div>
                </div>

                <div class="mb-3">
                    <label class="form-label">GST Type:</label><br>
                    <div class="form-check form-check-inline">
                        <input type="radio" class="form-check-input" name="gst_type" value="cgst_sgst" checked>
                        <label class="form-check-label">CGST + SGST</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input type="radio" class="form-check-input" name="gst_type" value="igst">
                        <label class="form-check-label">IGST</label>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Total Amount:</label>
                        <input type="number" class="form-control" name="total_amount" id="total_amount" readonly>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">GST Total:</label>
                        <input type="number" class="form-control" name="gst_total" id="gst_total" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">CGST:</label>
                        <input type="number" class="form-control" name="cgst" id="cgst" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">SGST:</label>
                        <input type="number" class="form-control" name="sgst" id="sgst" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">IGST:</label>
                        <input type="number" class="form-control" name="igst" id="igst" readonly>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Total Amount with GST:</label>
                        <input type="number" class="form-control" name="total_amount_with_gst"
                            id="total_amount_with_gst" readonly>
                    </div>
                </div>

                <div class="mt-4">
                    <button type="submit" name="submit_quotation" class="btn btn-success w-100">Submit
                        Quotation</button>
                </div>
            </div>
            {% endif %}
        </form>
    </div>

    <script>
        function goToStep(stepNum) {
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            document.querySelector('.step-' + stepNum).classList.add('active');
        }

        document.addEventListener('DOMContentLoaded', function () {
            const productFields = document.getElementById('product-fields');
            const serviceFields = document.getElementById('service-fields');
            const gstTypeRadios = document.querySelectorAll('input[name="gst_type"]');
            let gstType = 'cgst_sgst';

            document.querySelectorAll('.item-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    const type = this.getAttribute('data-type');
                    const container = type === 'product' ? productFields : serviceFields;
                    const id = this.value;

                    if (this.checked) {
                        const fieldHTML = `
                        <div class="item-group border rounded p-3" data-id="${id}" data-type="${type}">
                            <strong>${type.toUpperCase()} ID: ${id}</strong><br>
                            <label>Price:</label>
                            <input type="number" class="form-control mb-2 price" name="${type}_price_${id}" min="1">
                            <label>Quantity:</label>
                            <input type="number" class="form-control mb-2 quantity" name="${type}_quantity_${id}" min="1">
                            <label>GST %:</label>
                            <input type="number" class="form-control gst" name="${type}_gst_${id}" step="0.01">
                        </div>
                    `;
                        container.insertAdjacentHTML('beforeend', fieldHTML);
                        attachInputListeners();
                    } else {
                        container.querySelector(`[data-id="${id}"]`)?.remove();
                        calculateTotals();
                    }
                });
            });

            gstTypeRadios.forEach(radio => {
                radio.addEventListener('change', function () {
                    gstType = this.value;
                    calculateTotals();
                });
            });

            function attachInputListeners() {
                document.querySelectorAll('.price, .quantity, .gst').forEach(input => {
                    input.removeEventListener('input', calculateTotals);
                    input.addEventListener('input', calculateTotals);
                });
            }

            function calculateTotals() {
                let totalAmount = 0;
                let totalGST = 0;

                document.querySelectorAll('.item-group').forEach(group => {
                    const price = parseFloat(group.querySelector('.price')?.value) || 0;
                    const qty = parseFloat(group.querySelector('.quantity')?.value) || 0;
                    const gst = parseFloat(group.querySelector('.gst')?.value) || 0;

                    const itemTotal = price * qty;
                    const gstAmount = (itemTotal * gst) / 100;

                    totalAmount += itemTotal;
                    totalGST += gstAmount;
                });

                document.getElementById('total_amount').value = totalAmount.toFixed(2);
                document.getElementById('gst_total').value = totalGST.toFixed(2);
                document.getElementById('total_amount_with_gst').value = (totalAmount + totalGST).toFixed(2);

                if (gstType === 'cgst_sgst') {
                    document.getElementById('cgst').value = (totalGST / 2).toFixed(2);
                    document.getElementById('sgst').value = (totalGST / 2).toFixed(2);
                    document.getElementById('igst').value = '0.00';
                } else {
                    document.getElementById('cgst').value = '0.00';
                    document.getElementById('sgst').value = '0.00';
                    document.getElementById('igst').value = totalGST.toFixed(2);
                }
            }
        });
    </script>

</body>

</html>