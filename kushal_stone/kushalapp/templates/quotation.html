<!DOCTYPE html>
<html>
<head>
    <title>Create Quotation</title>
    <style>
        .step { display: none; }
        .step.active { display: block; }
    </style>
</head>
<body>
    <h2>Create Quotation</h2>

    {% if messages %}
        <ul>
            {% for message in messages %}
                <li style="color: {% if message.tags == 'error' %}red{% else %}green{% endif %};">
                    {{ message }}
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    <form method="POST">
        {% csrf_token %}

        <!-- Step 1: Customer Info -->
        <div class="step step-1 active">
            <h3>Step 1: Customer Info</h3>

            <label for="mobile">Mobile Number:</label>
            <input type="text" id="mobile" name="mobile" value="{{ lead.mobile_number|default:'' }}" required>
            <button type="submit" name="fetch_lead">Fetch Lead</button><br><br>

            {% if lead %}
                <label>Full Name:</label>
                <input type="text" value="{{ lead.full_name }}" readonly><br><br>

                <label>Email:</label>
                <input type="email" value="{{ lead.email }}" readonly><br><br>

                <label>Address:</label>
                <textarea readonly>{{ lead.address }}</textarea><br><br>

                <button type="button" onclick="goToStep(2)">Next</button>
            {% endif %}
        </div>

        <!-- Step 2: Quotation Info -->
        {% if lead %}
        <div class="step step-2">
    <h3>Step 2: Quotation Details</h3>

    <label>Select Products:</label><br>
    {% for product in products %}
        <input type="checkbox" class="item-checkbox" data-type="product" value="{{ product.id }}" name="products"> {{ product.name }}<br>
    {% endfor %}
    <div id="product-fields"></div>

    <br><label>Select Services:</label><br>
    {% for service in services %}
        <input type="checkbox" class="item-checkbox" data-type="service" value="{{ service.id }}" name="services"> {{ service.name }}<br>
    {% endfor %}
    <div id="service-fields"></div>

    <br><label>GST Type:</label>
    <input type="radio" name="gst_type" value="cgst_sgst" checked> CGST + SGST
    <input type="radio" name="gst_type" value="igst"> IGST
    <br><br>

    <label>Total Amount:</label>
    <input type="number" name="total_amount" id="total_amount" readonly><br><br>

    <label>GST Total:</label>
    <input type="number" name="gst_total" id="gst_total" readonly><br><br>

    <label>CGST:</label>
    <input type="number" name="cgst" id="cgst" readonly><br><br>

    <label>SGST:</label>
    <input type="number" name="sgst" id="sgst" readonly><br><br>

    <label>IGST:</label>
    <input type="number" name="igst" id="igst" readonly><br><br>

    <label>Total Amount with GST:</label>
    <input type="number" name="total_amount_with_gst" id="total_amount_with_gst" readonly><br><br>

    <button type="submit" name="submit_quotation">Submit Quotation</button>
</div>

        {% endif %}
    </form>

    <script>
        function goToStep(stepNum) {
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            document.querySelector('.step-' + stepNum).classList.add('active');
        }
    </script>


<script>
    // function goToStep(stepNum) {
    //     document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
    //     document.querySelector('.step-' + stepNum).classList.add('active');
    // }

    // Perform calculations
    
    document.addEventListener('DOMContentLoaded', function () {
        const productFields = document.getElementById('product-fields');
        const serviceFields = document.getElementById('service-fields');
        const gstTypeRadios = document.querySelectorAll('input[name="gst_type"]');
        let gstType = 'cgst_sgst';

        document.querySelectorAll('.item-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                const type = this.getAttribute('data-type');
                const container = type === 'product' ? productFields : serviceFields;

                if (this.checked) {
                    const id = this.value;
                    const fieldHTML = `
                        <div class="item-group" data-id="${id}" data-type="${type}">
                            <strong>${type.toUpperCase()} ID: ${id}</strong><br>
                            Price: <input type="number" class="price" name="${type}_price_${id}" min="1"><br>
                            Quantity: <input type="number" class="quantity" name="${type}_quantity_${id}" min="1"><br>
                            GST %: <input type="number" class="gst" name="${type}_gst_${id}" step="0.01"><br><br>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', fieldHTML);
                    attachInputListeners();
                } else {
                    container.querySelector(`[data-id="${this.value}"]`)?.remove();
                    calculateTotals();
                }
            });
        });

        gstTypeRadios.forEach(radio => {
            radio.addEventListener('change', function () {
                gstType = this.value;
                calculateTotals();
            });
        });

        function attachInputListeners() {
            document.querySelectorAll('.price, .quantity, .gst').forEach(input => {
                input.removeEventListener('input', calculateTotals);
                input.addEventListener('input', calculateTotals);
            });
        }

        function calculateTotals() {
            let totalAmount = 0;
            let totalGST = 0;

            document.querySelectorAll('.item-group').forEach(group => {
                const price = parseFloat(group.querySelector('.price')?.value) || 0;
                const qty = parseFloat(group.querySelector('.quantity')?.value) || 0;
                const gst = parseFloat(group.querySelector('.gst')?.value) || 0;

                const itemTotal = price * qty;
                const gstAmount = (itemTotal * gst) / 100;

                totalAmount += itemTotal;
                totalGST += gstAmount;
            });

            document.getElementById('total_amount').value = totalAmount.toFixed(2);
            document.getElementById('gst_total').value = totalGST.toFixed(2);
            document.getElementById('total_amount_with_gst').value = (totalAmount + totalGST).toFixed(2);

            if (gstType === 'cgst_sgst') {
                document.getElementById('cgst').value = (totalGST / 2).toFixed(2);
                document.getElementById('sgst').value = (totalGST / 2).toFixed(2);
                document.getElementById('igst').value = '0.00';
            } else {
                document.getElementById('cgst').value = '0.00';
                document.getElementById('sgst').value = '0.00';
                document.getElementById('igst').value = totalGST.toFixed(2);
            }
        }
    });
</script>


</body>
</html>
